!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ChatEngineSetupCore=t():e.ChatEngineSetupCore=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t){e.exports={findCookie:e=>{let t=null;return document.cookie.split(";").forEach(n=>{let r=n.split("=")[0],o=n.split("=")[1];r.endsWith(e)&&(t=o)}),t},callbackWithError:(e,t,n)=>n(e&&e.responseJSON&&e.responseJSON.message?e.responseJSON.message:t)}},function(e,t,n){n(2);const r=n(7),o=n(8),i=n(0);e.exports=class{constructor(){this.loginElement=$("#login"),this.provisionElement=$("#setup"),this.loadElement=$("#load"),this.errorElement=$("#error"),this.errorOutElement=$("#error-out"),this.statusElement=$("#status"),this.codeElement=$("#code"),this.outputElement=$("#output"),this.emailElement=$("#email"),this.passwordElement=$("#password"),this.loginElement.submit(this.onLoginRegister.bind(this)),this.provisionElement.submit(this.onSetup.bind(this)),this.userId=i.findCookie("pnAdminId");let e=i.findCookie("pnAdminToken");this.client=new r({session:e,debug:!1,endpoint:"https://admin.pubnub.com"}),this.userId&&e&&(this.provisionElement.show(),this.loginElement.hide(),this.identify(this.userId))}displayStatus(e){this.statusElement.show(),this.statusElement.append($('<li class="list-group-item">'+e+"</li>"))}clearErrors(){this.errorElement.hide()}raiseError(e){this.errorOutElement.html(e),this.errorElement.show()}onProvisionSuccess(e,t){if(e)this.loadElement.hide(),this.provisionElement.show(),this.errorOutElement.html(e),this.errorElement.show();else{this.loadElement.hide();let e="";e+="// Make sure to import ChatEngine first!\n",e+="ChatEngine = ChatEngineCore.create({\n",e+="    publishKey: '"+t.pub+"',\n",e+="    subscribeKey: '"+t.sub+"'\n",e+="});\n",this.track("chat_engine_activation"),this.codeElement.text(e),this.outputElement.show()}}onLoginRegister(){this.clearErrors();const e=this.emailElement.val(),t=this.passwordElement.val();return e&&""!==e?t&&""!==t?(this.client.init({email:e,password:t},(e,t)=>{e?this.raiseError((e=>{if(e&&e.responseJSON&&e.responseJSON.error)return e.responseJSON.error})(e)):(this.userId=t.result.user_id,this.identify(this.userId),this.provisionElement.show(),this.loginElement.hide())}),!1):(this.raiseError("password not valid"),!1):(this.raiseError("email not valid"),!1)}onSetup(){return this.clearErrors(),this.loadElement.show(),this.errorElement.hide(),this.statusElement.empty(),o(this.client,this.userId,this.onProvisionSuccess.bind(this),this.displayStatus.bind(this)),!1}identify(e){const t={type:"identify",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:e};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}track(e){const t={type:"track",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),event:e,context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:this.userId};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}}},function(e,t,n){"use strict";e.exports=n(3).polyfill()},function(e,t,n){(function(t,r){/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   4.1.1
 */
!function(t,n){e.exports=n()}(0,function(){"use strict";function e(e){return"function"==typeof e}function o(){var e=setTimeout;return function(){return e(i,1)}}function i(){for(var e=0;e<k;e+=2){(0,N[e])(N[e+1]),N[e]=void 0,N[e+1]=void 0}k=0}function s(e,t){var n=arguments,r=this,o=new this.constructor(a);void 0===o[q]&&v(o);var i=r._state;return i?function(){var e=n[i-1];x(function(){return y(i,o,e,r._result)})}():f(r,o,e,t),o}function u(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(a);return p(t,e),t}function a(){}function c(e){try{return e.then}catch(e){return M.error=e,M}}function l(t,n,r){n.constructor===t.constructor&&r===s&&n.constructor.resolve===u?function(e,t){t._state===F?h(e,t._result):t._state===W?d(e,t._result):f(t,void 0,function(t){return p(e,t)},function(t){return d(e,t)})}(t,n):r===M?(d(t,M.error),M.error=null):void 0===r?h(t,n):e(r)?function(e,t,n){x(function(e){var r=!1,o=function(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}(n,t,function(n){r||(r=!0,t!==n?p(e,n):h(e,n))},function(t){r||(r=!0,d(e,t))},e._label);!r&&o&&(r=!0,d(e,o))},e)}(t,n,r):h(t,n)}function p(e,t){e===t?d(e,new TypeError("You cannot resolve a promise with itself")):!function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)?h(e,t):l(e,t,c(t))}function h(e,t){e._state===I&&(e._result=t,e._state=F,0!==e._subscribers.length&&x(b,e))}function d(e,t){e._state===I&&(e._state=W,e._result=t,x(function(e){e._onerror&&e._onerror(e._result),b(e)},e))}function f(e,t,n,r){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+F]=n,o[i+W]=r,0===i&&e._state&&x(b,e)}function b(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,o=void 0,i=e._result,s=0;s<t.length;s+=3)r=t[s],o=t[s+n],r?y(n,r,o,i):o(i);e._subscribers.length=0}}function m(){this.error=null}function y(t,n,r,o){var i=e(r),s=void 0,u=void 0,a=void 0,c=void 0;if(i){if((s=function(e,t){try{return e(t)}catch(e){return H.error=e,H}}(r,o))===H?(c=!0,u=s.error,s.error=null):a=!0,n===s)return void d(n,new TypeError("A promises callback cannot return that same promise."))}else s=o,a=!0;n._state!==I||(i&&a?p(n,s):c?d(n,u):t===F?h(n,s):t===W&&d(n,s))}function v(e){e[q]=J++,e._state=void 0,e._result=void 0,e._subscribers=[]}function g(e,t){this._instanceConstructor=e,this.promise=new e(a),this.promise[q]||v(this.promise),E(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?h(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&h(this.promise,this._result))):d(this.promise,new Error("Array Methods must be provided an Array"))}function _(e){this[q]=J++,this._result=this._state=void 0,this._subscribers=[],a!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof _?function(e,t){try{t(function(t){p(e,t)},function(t){d(e,t)})}catch(t){d(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}var w=void 0,E=w=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},k=0,P=void 0,T=void 0,x=function(e,t){N[k]=e,N[k+1]=t,2===(k+=2)&&(T?T(i):$())},S="undefined"!=typeof window?window:void 0,j=S||{},C=j.MutationObserver||j.WebKitMutationObserver,A="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),O="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,N=new Array(1e3),$=void 0;$=A?function(){return t.nextTick(i)}:C?function(){var e=0,t=new C(i),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}():O?function(){var e=new MessageChannel;return e.port1.onmessage=i,function(){return e.port2.postMessage(0)}}():void 0===S?function(){try{var e=n(6);return void 0!==(P=e.runOnLoop||e.runOnContext)?function(){P(i)}:o()}catch(e){return o()}}():o();var q=Math.random().toString(36).substring(16),I=void 0,F=1,W=2,M=new m,H=new m,J=0;return g.prototype._enumerate=function(e){for(var t=0;this._state===I&&t<e.length;t++)this._eachEntry(e[t],t)},g.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===u){var o=c(e);if(o===s&&e._state!==I)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(n===_){var i=new n(a);l(i,e,o),this._willSettleAt(i,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},g.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===I&&(this._remaining--,e===W?d(r,n):this._result[t]=n),0===this._remaining&&h(r,this._result)},g.prototype._willSettleAt=function(e,t){var n=this;f(e,void 0,function(e){return n._settledAt(F,t,e)},function(e){return n._settledAt(W,t,e)})},_.all=function(e){return new g(this,e).promise},_.race=function(e){var t=this;return new t(E(e)?function(n,r){for(var o=e.length,i=0;i<o;i++)t.resolve(e[i]).then(n,r)}:function(e,t){return t(new TypeError("You must pass an array to race."))})},_.resolve=u,_.reject=function(e){var t=new this(a);return d(t,e),t},_._setScheduler=function(e){T=e},_._setAsap=function(e){x=e},_._asap=x,_.prototype={constructor:_,then:s,catch:function(e){return this.then(null,e)}},_.polyfill=function(){var e=void 0;if(void 0!==r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=_},_.Promise=_,_})}).call(t,n(4),n(5))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(e){if(a===setTimeout)return setTimeout(e,0);if((a===n||!a)&&setTimeout)return a=setTimeout,setTimeout(e,0);try{return a(e,0)}catch(t){try{return a.call(null,e,0)}catch(t){return a.call(this,e,0)}}}function i(){if(!d){var e=o(function(){d&&p&&(d=!1,p.length?h=p.concat(h):f=-1,h.length&&i())});d=!0;for(var t=h.length;t;){for(p=h,h=[];++f<t;)p&&p[f].run();f=-1,t=h.length}p=null,d=!1,function(e){if(c===clearTimeout)return clearTimeout(e);if((c===r||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(e);try{c(e)}catch(t){try{return c.call(null,e)}catch(t){return c.call(this,e)}}}(e)}}function s(e,t){this.fun=e,this.array=t}function u(){}var a,c,l=e.exports={};!function(){try{a="function"==typeof setTimeout?setTimeout:n}catch(e){a=n}try{c="function"==typeof clearTimeout?clearTimeout:r}catch(e){c=r}}();var p,h=[],d=!1,f=-1;l.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];h.push(new s(e,t)),1!==h.length||d||o(i)},s.prototype.run=function(){this.fun.apply(null,this.array)},l.title="browser",l.browser=!0,l.env={},l.argv=[],l.version="",l.versions={},l.on=u,l.addListener=u,l.once=u,l.off=u,l.removeListener=u,l.removeAllListeners=u,l.emit=u,l.prependListener=u,l.prependOnceListener=u,l.listeners=function(e){return[]},l.binding=function(e){throw new Error("process.binding is not supported")},l.cwd=function(){return"/"},l.chdir=function(e){throw new Error("process.chdir is not supported")},l.umask=function(){return 0}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){},function(e,t){e.exports=class{constructor(e){e=e||{},this.endpoint=e.endpoint||"https://admin.pubnub.com",this.session=e.session||!1,this.debug=e.debug||!1}errHandle(e){this.debug&&console.error("API Error: "+e)}clog(e){this.debug&&("object"==typeof e?console.log(e):console.log("API:".yellow,e))}request(e,t,n,r){if("me"!==t[1]&&!this.session)return this.errHandle("Authorize with init() first.");(n=n||{}).url=this.endpoint+"/"+t.join("/"),n.method=e,n.json=!0,n.headers=n.headers||{},this.session&&(n.headers["X-Session-Token"]=this.session),this.clog(n.method.red+" "+n.url),this.clog("-- opts:".yellow),this.clog(n),$.ajax(n).done(e=>{console.log(e),r(null,e)}).fail(e=>{console.log("fail",e),r(e||e.message||e)})}init(e,t){this.request("post",["api","me"],{data:{email:e.email||this.errHandle("No Email Supplied"),password:e.password||this.errHandle("No Password Supplied")}},(e,n)=>{n&&n.error?t(n.error):e?t(e):(this.session=n.result.token,t(null,n))})}startFunction({block:e,key:t},n){this.request("post",["api","v1","blocks","key",t.id,"block",e.id,"start"],{data:{block_id:e.id,key_id:t.id,action:"start"}},n)}storeSecretKey({key:e},t){this.request("put",["api","vault",e.subscribe_key,"key","secretKey"],{contentType:"application/json",data:JSON.stringify({keyName:"secretKey",key_id:e.id,subscribeKey:e.subscribe_key,value:e.secret_key})},t)}}},function(e,t,n){const r=n(9),o=n(0);e.exports=((e,t,n=(()=>{}),i=(()=>{}))=>{e.request("get",["api","accounts"],{data:{user_id:t}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub accounts. Please contact support@pubnub.com.",n)}let a=u.result.accounts[0];i("Using account "+a.properties.company+", if this is incorrect, deploy manually or log in as another user"),i("Creating new PubNub app..."),e.request("post",["api","apps"],{data:{name:"ChatEngine App",owner_id:a.id,properties:{}}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not create new PubNub app. Please contact support@pubnub.com.",n)}let c=u.result;i("Getting PubNub keys..."),e.request("get",["api","apps"],{data:{owner_id:a.id}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub keys. Please contact support@pubnub.com.",n)}let a;u.result.forEach(e=>{e.id===c.id&&(a=e.keys[0])}),i("Enabling PubNub features..."),a.properties.name="ChatEngine Keyset",a.properties.presence=1,a.properties.history=1,a.properties.message_storage_ttl=7,a.properties.multiplexing=1,a.properties.presence_announce_max=20,a.properties.presence_debounce=2,a.properties.presence_global_here_now=1,a.properties.presence_interval=10,a.properties.presence_leave_on_disconnect=0,a.properties.blocks=1,a.properties.uls=1,a.properties.wildcardsubscribe=1,e.request("put",["api","keys",a.id],{data:a},s=>{if(s){return o.callbackWithError(s,"Could not enable PubNub features. Please contact support@pubnub.com.",n)}r(e,t,a,n,i)})})})})})},function(e,t,n){const r=n(0);e.exports=((e,t,n,o=(()=>{}),i=(()=>{}))=>{let s=null;i("Creating new PubNub Function...");e.request("post",["api","v1","blocks","key",n.id,"block"],{data:{name:"ChatEngine Function",key_id:n.id}},(t,u)=>{if(t){return r.callbackWithError(t,"Could not create new PubNub Function. Please contact support@pubnub.com.",o)}s=u.payload;let a=$.get({url:"functions/state-to-kv.js",dataType:"text"}),c=$.get({url:"functions/auth.js",dataType:"text"}),l=$.get({url:"functions/server.js",dataType:"text"});$.when(a,c,l).then((t,u,a)=>{i("Creating new after-publish Event Handler..."),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-after-presence",channels:"*",name:"chat-engine-state",code:t[0],output:"output-state-to-kv-"+(new Date).getTime()}},(t,c)=>{if(t)return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o);e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-on-rest",path:"chat-engine-auth",name:"chat-engine-auth",code:u[0],output:"auth-"+Math.round((new Date).getTime())}},(t,u)=>{if(t)return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o);i("Creating new on-request Event Handler..."),a[0]=a[0].replace("SECRET_KEY",n.secret_key),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,code:a[0],type:"js",name:"chat-engine-server",path:"chat-engine-server",event:"js-on-rest",output:"output-server-endpoint-"+Math.round((new Date).getTime())}},(t,u)=>{if(t)return r.callbackWithError(t,"Could not create new Pubnub on-request Event Handler. Please contact support@pubnub.com.",o);i("Starting Pubnub Function..."),e.startFunction({block:s,key:n},e=>{if(e)return r.callbackWithError(e,"Could not start PubNub Function. Please contact support@pubnub.com.",o);i("Success!"),o(null,{pub:n.publish_key,sub:n.subscribe_key})})})})})}).catch(()=>{i("Failed to fetch code")})})})}])});